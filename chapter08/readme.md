# 8장 서드 파티 코드를 기반으로 한 개발

- 서드 파티 코드는 제어가 불가능하기 때문에 시스템과 어떻게 통합할 것인가에 집중해야 한다.
- 통합 설계의 핵심은 API가 제공하는 우아함과 우리 도메인 설계의 실용성 두 가지 사이에서 최적의 균형점을 찾는 것이다.

## 8.1 소유한 타입에 대해서만 목 객체를 적용하라

### 8.1.1 변경할 수 없는 타입에 대해서는 목 객체를 적용하지 말라

- 서드 파티 코드는 테스트하기 전까지 동작을 확신할 수 없다.
- 서드 파티 API는 직접 수정할 수 없기 때문에 단위 테스트를 통해 설계 피드백을 받아도 반영할 수 없다.
- 서드 파티 타입의 목 객체 사용은 제한적이다.
    - 서드 파티 API를 목 객체로 사용하기 위해선 외부 라이브러리에 대해 파악해야 하고, 이는 테스트가 외부 구현과 과도하게 결합되는 상태를 초래한다.
    - 테스트가 복잡하다는 사실은 설계가 잘못됐다는 신호임에도, 개선할 대산이 서드 파티 API로 직접 수정할 수 없다.
    - 결과적으로 복잡해진 테스트 유지를 위해 코드와 테스트 모두 더 복잡해지는 악순환이 생긴다.
- 외부 위험 요소를 스텁이나 목으로 대체할 때, 외부 라이브러리에서 실제 수행할 API와 동일하게 동작한다는 보장을 제공하지 못한다.

### 8.1.2 어댑터 계층을 작성하라

- 서드 파티 API와 직접 결합하지 않고, “인터페이스”를 먼저 정의해야 한다.
    - 인터페이스는 외부 라이브러리가 아닌 도메인 관점에서 정의되아야 한다.
      <img width="400" height="200" alt="Image" src="https://github.com/user-attachments/assets/0bc7d46a-f548-4bf6-9c57-b8553c25c08e" />
    - 서드 파티 API와 상호작용은 어댑터(adapter) 계층에 작성해야 한다.
        - 서드 파티 코드 자체가 불안정하거나 테스트하기 어려운 코드의 양을 줄이기 위해 얇게 유지해야 한다.
        - 어댑터는 집중적인 통합 테스트를 통해 검증할 수 있다.
    - 이러한 접근법은 도메인 모델과 외부 기술 요소와의 관계를 규정하는 인터페이스가 만들어지고, 외부 기술에 대한 개념이 도메인 모델로 스며들지 않게 할 수 있다.
- 서드 파티 라이브러리를 실행하기 어려운 경우 목 객체가 도움이 될 수 있다.
    - 테스트 스위트에 서드 파티를 위한 테스트가 많아지는 것은 좋지 않다.
    - 값 타입은 목 객체를 적용할 필요가 없지만, 외부 값 타입을 계속 사용할 것인지 도메인에 맞는 값 타입으로 변환할 것인지 설계적으로 판단해야 한다.

## 8.2 통합 테스트에서 애플리케이션 객체에 목 객체를 적용하라

- 어댑터 객체는 보통 수동적이기 때문에 외부 API의 호출 결과나 이벤트를 받아서 도메인 객체에게 전달하는 역할만 한다.
    - 하지만 외부 시스템으로부터 콜백을 받은 경우, 이벤트를 도메인 이벤트로 적절히 변환해야 한다.
    - 통합 테스트에서는 어댑터가 도메인 사이에서 이벤트를 올바르게 번역하는지 검증하기 위해 애플리케이션에서 정의한 콜백 인터페이스에 목 객체를 적용한다.

  <img width="500" height="250" alt="Image" src="https://github.com/user-attachments/assets/55273f7b-7ac2-4df7-8c4f-1807363d7c9c" />

- 다중 스레드 처리를 하면 동기화가 필수적인 요소가 되기 때문에 테스트의 복잡성이 가중된다.
